# Script: fix_prepaid_end_dates
# Algorithm: Find all VY and VY+ transactions, and for those who have an EFT profile, fix their ClientProfile's Member#_Exp to the appropriate amount for their purchase (425 days for VY, 545 days for VY+), and fix their Eft's End_Date to the date they purchased the prepaid.
# This file is to be run in the context of the application: To run, use ./script/runner

# sql = case ::RAILS_ENV
# when 'development'
#   old_date_s = "2008-07-04" # this is 545 days before 12/31/2009
#   "(Code = 'VY' OR Code = 'VY+') AND CType != ? AND CType != ? AND Last_Mdt > ?"
# when 'production'
#   old_date_s = "20080704" # this is 545 days before 12/31/2009
#   "([Code] = 'VY' OR [Code] = 'VY+') AND [CType] != ? AND [CType] != ? AND [Last_Mdt] > ?"
# end
# 
# clients = Helios::Transact.find(:all, :conditions => [sql, '1', '2', old_date_s])
clients = [1000160,1000092,1000176,1000186,1000208,1000241,1000283,1000392,1000394,1000399,1000436,1000446,1000479,1000524,1000525,1000527,1000582,1000099,1000139,1000416,1000610,1000852,1000949,1000993,1000996,1001144,1001702,1001708,1001737,1001750,1001855,1001877,1001881,1001920,1001933,1001937,1001969,1002038,1002061,1002166,1002215,1002225,1002247,1002250,1002336,1002429,1002478,1002534,1002640,1002650,1002696,1002818,1002941,1000774,1000825,1001033,1001091,1001107,1001198,1003173,1002965,1003373,1003497,1003528,1003535,1003661,1003663,1003687,1003711,1003720,1003785,1003857,1003987,1004031,1004049,1004060,1004070,1004084,1004125,1004143,1004205,1004355,1004390,1004540,1004660,1004675,1004676,1004677,1004694,1004759,1004789,1003174,1004900,1005000,1005053,1005105,1005204,1005240,1005256,1005285,1004804,1004872,1004874,1005371,1005425,1005489,1005531,1005625,1005706,1005719,1005734,1005772,1005787,1005827,1005984,1005990,1006111,1006278,1006305,1006365,1006491,1006497,1006548,1006656,1006744,1006853,1006998,1007015,1007032,1007038,1005287,1007100,1007126,1007135,1007147,1007158,1007162,1007232,1007041,1007042,1007077,1007396,1007455,1007583,1007686,1007698,1007830,1007869,1007904,1007915,1007970,1008116,1008131,1007268,1007271,1007279,1007287,1007309,1007318,1007321,1008283,1008299,1008174,2000043,2000122,2000130,2000135,2000171,2000238,2000266,2000270,2000291,2000309,2000335,2000342,2000448,2000524,2000556,2000567,2000568,2000580,2000589,2000593,2000611,2000644,2000685,2000699,2000767,2000826,2000951,2001010,2001018,2001021,2001025,2001078,2001243,2001340,2001508,3000012,3000065,3000091,3000251,3000252,3000305,3000349,3000375,3000400,3000449,3000114,3000124,3000143,3000189,3000191,3000696,3000815,3000847,3000879,3000962,3001015,3001029,3001053,3001055,3001058,3001063,3001082,3001094,3001129,3001132,3001166,3001175,3001233,3001326,3001375,3001384,3001388,3001428,3001532,3001552,3001558,3001563,3001575,3001601,3001603,3001680,3001801,3001810,3001813,3001831,3001851,3001852,3001865,3001876,3001908,3001960,3001970,3001973,3001978,3001980,3001982,3001993,3002013,3002050,3002081,3002092,3002098,3002136,3002231,3002251,3002314,3002354,3002368,3002371,3000532,3002561,3002586,3002590,3002595,3002597,3002618,3002628,3002661,3002400,3002429,3002502,3002511,3002525,3002767,3002781,3002794,3002797,3002907,3002931,3003019,3003024,3003034,3003039,3003053,3003062,3003063,3003122,3003124,3003169,3003201,3003205,3003260,3003291,3003300,3003320,3003322,3003324,3003359,3003360,3003411,3003442,3003464,3003498,3003499,3003601,3003637,3003689,3003799,3003821,3003836,3003952,3003953,3002666,3002713,3004102,3004182,3004305,3004379,3004382,3003964,3004018,3004043,3004563,3004655,3004682,3004719,3004844,3005017,3005057,3005132,3005263,3005355,3005445,3005494,3004399,3004429,3004459,3005573,3005588,3005665,3005809,3005818,3005840,3005511,3005519,3006083,3006107,3006116,3006122,3006184,3006186,3006208,3006290,3006291,3006339,3006349,3006510,3006616,3006668,3006752,3006758,3006763,3006765,3006767,3006770,3006778,3006788,3006795,3006796,3006824,3006876,3006978,3007024,3007116,3007161,3007168,3007187,3007256,3007335,3007459,3007481,3007545,3007547,3007566,3007580,3007677,3007713,3007739,3007770,3007772,3007819,3007838,3007856,3007859,3007870,3007947,3005977,3005991,4000112,4000119,4000142,4000153,4000027,4000048,4000066,4000071,4000092,4000093,4000242,4000273,4000323,4000365,4000382,4000450,4000462,4000500,4000515,4000519,4000527,4000534,4000582,4000619,4000637,4000639,4000684,4000691,4000861,4000882,4000883,4000901,4000960,4001013,4001048,4001052,4001173,4001179,4001258,4001289,4001313,4001321,4001601,4001617,4001732,4000192,4000194,4000216,4000221,4001994,4002002,4002115,4002220,4001737,4001846,4002445,4002447,4002455,4002466,4002525,4002557,4002561,4002577,4002738,4002824,4002891,4005518,4005524,4005619,4005844,4005947,4005991,4006027,4006031,4006071,4006114,4006176,4006228,4006237,4006333,4006384,4006436,4006551,4006679,4006801,4002306,4002388,4002414,4006994,4007008,4007059,4007078,4007090,4006935,4006953,4007343,4007382,4007775,4007844,4007846,4007863,5000838,5002134,5002234,5002237,5002683,5002735,5002842,5002982,5003381,5003414,5003515,5003538,5002473,5004673,5004697,5005395,6000005,6000008,6000014,6000042,6000172,6000187,6000435,6000557,6000578,6000605,6000617,6000623,6000627,6000652,6000660,6000680,6000712,6000718,6000737,6000846,6000872,6000877,6000936,6000950,6000980,6001012,7000031,7000049,7000059,7000073,7000082,7000087,7000091,7000205,7000221,7000235,7000240,7000322,7000391,7000399,7000447,7000523,7000561,7000582,7000598,7000614,7000652,7000664,7000686,7000711,7000740,7000750,7000759,7000838,7000862,7000885,7000916,7000918,5003854,7001068,7001118,7001132,7001133,7001135,7001140,7001205,7001210,7000925,7000926,7001240,7001316,7001322,7001324,7001340,7001344,7001359,7001362,7001403,7001572,7001754,7001820,7001826,7001850,7001217,7002059,7002060,7002095,7002114,7002146,7002160,7002170,7002269,7002272,7002275,7002278,7002283,7002304,7002333,7002363,7002389,7001970,7001995,7002014,7002475,7002489,7002495,7002498,7002504,7002517,7002430,7002432,7002442,7002607,7002633,7002643,7002644,7002704,7002734,7002532,7002536,7002585,7002606,7002861,7002874,7002899,7002902,7002931,7002962,7002982,7002992,7003019,7003038,7003040,7003067,7003148,7003209,7003228,7003290,7003293,7003319,7003345,7003389,7003468,7003495,7003520,7003526,7003541,7002788,7002798,7002803,7002811,7002834,7002838,7002841,7003635,7003641,7003558,7003587,7003591,7003607,7003611,7003758,7003813,7003814,7003818,7003834,7003857,7003866,7003928,7003971,7003681,7003684,7003690,7003710,7004099,7004110,7004141,7004186,7004204,7004007,7004030,7004081,7004229,7004296,7004337,7004383,7004420,7004460,7004501,7004502,7004527,7004569,7004613,7004208,7005477,8001943,10000916,10001017]

count_updated = 0
count_not_prepaid = 0
count_skipped = 0

puts "Filtering through #{clients.length} clients."
clients.each do |client_id|
  count_skipped += 1
  confirm_step "Begin next client? (#{client_id})", 'begin-next' do
    report = Helios::ClientProfile.report_membership!(client_id,Time.parse("2009-12-31"))
    if report =~ /prepaid/
      client = report.instance_variable_get(:@client)
      prepaid = report.instance_variable_get(:@prepaid)
      eft = report.instance_variable_get(:@eft)
      vip_expire_date = (prepaid.Last_Mdt + ((prepaid.Code == 'VY' ? 425 : 545) * 24*60*60)).to_date.to_time # number of days following.
      msg = "\n#{client_id}: #{report}\nChange: #{client.Member1 == 'VIP' ? 'client.Member1_Exp' : 'client.Member2_Exp'}=#{vip_expire_date.strftime("%Y-%m-%d")}"
      msg << ", EFT.End_Date=#{prepaid.Last_Mdt.to_time.strftime("%Y-%m-%d")}" if eft
      confirm_step msg, 'fix-end-date' do
        $CONFIRM_CONTINUE['begin-next'] = false
        count_skipped -= 1
        count_updated += 1
        if(client.Member1 == 'VIP')
          Helios::ClientProfile.connection.execute("UPDATE Client_Profile SET [Member1_Exp] = '#{vip_expire_date.strftime("%Y-%m-%d %H:%M:%S")}', [UpdateAll] = '#{Time.now.strftime("%Y-%m-%d %H:%M:%S")}' WHERE [Client_no] = '#{client.Client_no}'")
        elsif(client.Member2 == 'VIP')
          Helios::ClientProfile.connection.execute("UPDATE Client_Profile SET [Member2_Exp] = '#{vip_expire_date.strftime("%Y%m%d %H:%M:%S")}', [UpdateAll] = '#{Time.now.strftime("%Y%m%d %H:%M:%S")}' WHERE [Client_no] = '#{client.Client_no}'")
        end
        eft.update_attributes(
          :End_Date => prepaid.Last_Mdt.to_time,
          :UpdateAll => Time.now
        ) if eft
      end
    else
      count_skipped -= 1
      count_not_prepaid += 1
      puts "Client #{client_id} is not prepaid.#{" Use 'YA' to continue to the next prepaid without prompt." if $CONFIRM_CONTINUE['begin-next']!='Y'}"
    end
  end
end

puts "Done: #{count_updated} Updated, #{count_not_prepaid} not Prepaid, #{count_skipped} Skipped."
